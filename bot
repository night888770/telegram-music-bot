
import os
import sqlite3
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext, MessageHandler, Filters
from youtube_search import YoutubeSearch
import youtube_dl

TOKEN = "7862387777:AAFBIkj58k5jUj_fY-GdsaI1gNZnLCY2N2s"
ADMIN_IDS = [8170796045]
DB_NAME = "bot_database.db"

def init_db():
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute('''CREATE TABLE IF NOT EXISTS group_settings
                     (chat_id INTEGER PRIMARY KEY, 
                      welcome_msg TEXT, 
                      rules TEXT,
                      max_warns INTEGER DEFAULT 3)''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS banned_users
                     (user_id INTEGER, 
                      chat_id INTEGER,
                      reason TEXT,
                      banned_by INTEGER,
                      ban_date TIMESTAMP,
                      PRIMARY KEY (user_id, chat_id))''')
    cursor.execute('''CREATE TABLE IF NOT EXISTS warnings
                     (user_id INTEGER,
                      chat_id INTEGER,
                      warning TEXT,
                      warned_by INTEGER,
                      warn_date TIMESTAMP)''')
    conn.commit()
    conn.close()

init_db()

def download_song(query, chat_id):
    try:
        ydl_opts = {
            'format': 'bestaudio/best',
            'postprocessors': [{
                'key': 'FFmpegExtractAudio',
                'preferredcodec': 'mp3',
                'preferredquality': '192',
            }],
            'outtmpl': f'{chat_id}.%(ext)s',
        }
        with youtube_dl.YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(f"ytsearch:{query}", download=True)['entries'][0]
            return {'file': f'{chat_id}.mp3', 'title': info['title'], 'duration': info['duration']}
    except Exception as e:
        print(f"Error: {e}")
        return None

def warn_user(chat_id, user_id, reason, admin_id):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("INSERT INTO warnings VALUES (?, ?, ?, ?, ?)",
                   (user_id, chat_id, reason, admin_id, datetime.now()))
    cursor.execute("SELECT COUNT(*) FROM warnings WHERE user_id=? AND chat_id=?", (user_id, chat_id))
    warn_count = cursor.fetchone()[0]
    cursor.execute("SELECT max_warns FROM group_settings WHERE chat_id=?", (chat_id,))
    result = cursor.fetchone()
    max_warns = result[0] if result else 3
    conn.commit()
    conn.close()
    return warn_count >= max_warns

def ban_user(chat_id, user_id, reason, admin_id):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    try:
        cursor.execute("INSERT INTO banned_users VALUES (?, ?, ?, ?, ?)",
                       (user_id, chat_id, reason, admin_id, datetime.now()))
        conn.commit()
        return True
    except:
        return False
    finally:
        conn.close()

def get_group_settings(chat_id):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM group_settings WHERE chat_id=?", (chat_id,))
    settings = cursor.fetchone()
    conn.close()
    if not settings:
        return {
            'welcome_msg': "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!",
            'rules': "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.",
            'max_warns': 3
        }
    return {
        'welcome_msg': settings[1],
        'rules': settings[2],
        'max_warns': settings[3]
    }

def start(update: Update, context: CallbackContext):
    user = update.effective_user
    buttons = [
        [InlineKeyboardButton("ğŸµ Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰", callback_data='music_section')],
        [InlineKeyboardButton("âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", callback_data='group_management')],
        [InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data='stats'),
         InlineKeyboardButton("â„¹ï¸ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©", callback_data='help')]
    ]
    update.message.reply_text(
        f"Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}!
"
        "ğŸ‘‘ Ø£Ù†Ø§ Ø¨ÙˆØªÙƒ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰

"
        "Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:",
        reply_markup=InlineKeyboardMarkup(buttons)
    )

def handle_music_section(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    buttons = [
        [InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø£ØºÙ†ÙŠØ©", callback_data='search_song')],
        [InlineKeyboardButton("ğŸµ ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±", callback_data='play_song')],
        [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data='main_menu')]
    ]
    query.edit_message_text("ğŸ¶ Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰:

Ø§Ø®ØªØ± Ø£Ø­Ø¯ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª:", reply_markup=InlineKeyboardMarkup(buttons))

def handle_group_management(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    if query.from_user.id not in ADMIN_IDS:
        query.edit_message_text("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©!")
        return
    buttons = [
        [InlineKeyboardButton("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡", callback_data='member_management')],
        [InlineKeyboardButton("âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", callback_data='group_settings')],
        [InlineKeyboardButton("ğŸ“ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†", callback_data='group_rules')],
        [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data='main_menu')]
    ]
    query.edit_message_text("âš™ï¸ Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:

Ø§Ø®ØªØ± Ø£Ø¯Ø§Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:", reply_markup=InlineKeyboardMarkup(buttons))

def handle_member_management(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    buttons = [
        [InlineKeyboardButton("ğŸ”‡ ÙƒØªÙ… Ø¹Ø¶Ùˆ", callback_data='mute_member'),
         InlineKeyboardButton("ğŸš« Ø­Ø¸Ø± Ø¹Ø¶Ùˆ", callback_data='ban_member')],
        [InlineKeyboardButton("âœ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±", callback_data='unban_member'),
         InlineKeyboardButton("âš ï¸ Ø¥Ø¹Ø·Ø§Ø¡ ØªØ­Ø°ÙŠØ±", callback_data='warn_member')],
        [InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data='group_management')]
    ]
    query.edit_message_text("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:

Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:", reply_markup=InlineKeyboardMarkup(buttons))

def handle_messages(update: Update, context: CallbackContext):
    if 'mode' not in context.user_data:
        return
    if context.user_data['mode'] == 'search':
        results = YoutubeSearch(update.message.text, max_results=5).to_dict()
        buttons = []
        for i, result in enumerate(results[:5]):
            buttons.append([InlineKeyboardButton(f"{i+1}. {result['title']} ({result['duration']})",
                                                 callback_data=f"download_{result['id']}")])
        update.message.reply_text("ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«:", reply_markup=InlineKeyboardMarkup(buttons))
    elif context.user_data['mode'] == 'play':
        song = download_song(update.message.text, update.message.chat_id)
        if song:
            update.message.reply_audio(audio=open(song['file'], 'rb'),
                                       title=song['title'],
                                       duration=song['duration'])
            os.remove(song['file'])
        else:
            update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„!")

def button_click(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    if query.data == 'main_menu':
        start(update, context)
    elif query.data == 'music_section':
        handle_music_section(update, context)
    elif query.data == 'group_management':
        handle_group_management(update, context)
    elif query.data == 'member_management':
        handle_member_management(update, context)
    elif query.data == 'search_song':
        query.edit_message_text("ğŸ” Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ø£ØºÙ†ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡Ø§:")
        context.user_data['mode'] = 'search'
    elif query.data == 'play_song':
        query.edit_message_text("ğŸµ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø£ØºÙ†ÙŠØ©:")
        context.user_data['mode'] = 'play'
    elif query.data.startswith('download_'):
        video_id = query.data.split('_')[1]
        song = download_song(video_id, query.message.chat_id)
        if song:
            query.message.reply_audio(audio=open(song['file'], 'rb'),
                                      title=song['title'],
                                      duration=song['duration'])
            os.remove(song['file'])
        else:
            query.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„!")

def main():
    updater = Updater(TOKEN, use_context=True)
    dp = updater.dispatcher
    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CallbackQueryHandler(button_click))
    dp.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_messages))
    print(f"ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…: {ADMIN_IDS[0]}")
    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    print("âš¡ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ...")
    print(f"ğŸ‘¤ Ø£Ù†Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ID: {ADMIN_IDS[0]})")
    main()
